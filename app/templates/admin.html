{% extends "base.html" %}
{% block title %}Admin — Epstein Files{% endblock %}

{% block content %}
<section class="admin-page">
    <h1>Admin / AI Worker</h1>

    <div class="admin-section admin-section-highlight">
        <h2>AI Analysis Worker</h2>
        <p>The worker fetches documents from the archive, sends them to a local LLM (via Ollama),
           and stores AI-discovered categories, entities, and relevance scores.</p>

        <div class="worker-status-panel" id="worker-panel">
            <div class="worker-status-row">
                <span class="worker-status-label">Worker:</span>
                <span class="worker-status-value" id="ws-running">
                    {% if worker.running %}
                    <span class="badge badge-success">Running</span>
                    {% else %}
                    <span class="badge badge-type">Stopped</span>
                    {% endif %}
                </span>
            </div>
            <div class="worker-status-row">
                <span class="worker-status-label">Current task:</span>
                <span class="worker-status-value" id="ws-task">{{ worker.current_task }}</span>
            </div>
            <div class="worker-status-row">
                <span class="worker-status-label">Documents analysed:</span>
                <span class="worker-status-value" id="ws-docs">{{ worker.documents_analysed }}</span>
            </div>
            <div class="worker-status-row">
                <span class="worker-status-label">Categories discovered:</span>
                <span class="worker-status-value" id="ws-cats">{{ worker.categories_discovered }}</span>
            </div>
            {% if worker.last_error %}
            <div class="worker-status-row">
                <span class="worker-status-label">Last error:</span>
                <span class="worker-status-value worker-error">{{ worker.last_error }}</span>
            </div>
            {% endif %}

            <div class="worker-controls">
                {% if worker.running %}
                <button class="btn btn-secondary" onclick="workerAction('stop')">Stop Worker</button>
                {% else %}
                <button class="btn btn-primary" onclick="workerAction('start')">Start AI Worker</button>
                {% endif %}
                <button class="btn btn-secondary" onclick="refreshStatus()">Refresh Status</button>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <h2>Ollama Status</h2>
        <div class="worker-status-panel">
            <div class="worker-status-row">
                <span class="worker-status-label">Status:</span>
                <span class="worker-status-value">
                    {% if ollama.status == 'running' %}
                    <span class="badge badge-success">Running</span>
                    {% else %}
                    <span class="badge badge-warning">Not Running</span>
                    {% endif %}
                </span>
            </div>
            <div class="worker-status-row">
                <span class="worker-status-label">URL:</span>
                <span class="worker-status-value">{{ ollama.url }}</span>
            </div>
            <div class="worker-status-row">
                <span class="worker-status-label">Configured model:</span>
                <span class="worker-status-value">{{ ollama.configured_model }}</span>
            </div>
            <div class="worker-status-row">
                <span class="worker-status-label">Available models:</span>
                <span class="worker-status-value">{{ ollama.models | join(', ') or 'None' }}</span>
            </div>
        </div>
        {% if ollama.status != 'running' %}
        <div class="admin-help">
            <h4>Setup Ollama</h4>
            <p>Install Ollama from <a href="https://ollama.ai" target="_blank" rel="noopener">ollama.ai</a>, then:</p>
            <code class="admin-code">ollama pull llama3.1:8b</code>
            <p>On Mac M4 Pro (64GB), the 8B model runs comfortably. For a data centre, use a larger model:</p>
            <code class="admin-code">OLLAMA_MODEL=llama3.1:70b  # set in environment</code>
        </div>
        {% endif %}
    </div>

    {% if ai_categories %}
    <div class="admin-section">
        <h2>AI-Discovered Categories ({{ ai_categories | length }})</h2>
        <div class="category-grid">
            {% for cat in ai_categories %}
            <a href="{{ url_for('main.category_view', slug=cat.slug) }}" class="category-card category-card-ai">
                <h4>{{ cat.name }}</h4>
                <span class="badge">{{ cat.document_count or 0 }} docs</span>
                {% if cat.description %}
                <p>{{ cat.description }}</p>
                {% endif %}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if worker.recent_analyses %}
    <div class="admin-section">
        <h2>Recent AI Analyses</h2>
        <div class="results-list">
            {% for a in worker.recent_analyses | reverse %}
            <div class="result-card">
                <div class="result-header">
                    <a href="{{ url_for('main.search_page', q=a.file_id) }}" class="result-title">{{ a.file_id }}</a>
                    <span class="badge badge-relevance badge-relevance-{{ 'high' if a.relevance > 0.5 else 'medium' if a.relevance > 0.2 else 'low' }}">
                        {{ '%.0f' | format(a.relevance * 100) }}%
                    </span>
                </div>
                <p class="result-snippet">{{ a.summary }}</p>
                {% if a.categories %}
                <div class="result-categories">
                    {% for cat in a.categories %}
                    <a href="{{ url_for('main.search_page', q=cat) }}" class="category-tag">{{ cat }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                {% if a.new_categories %}
                <div class="result-categories">
                    {% for cat in a.new_categories %}
                    <a href="{{ url_for('main.search_page', q=cat) }}" class="category-tag category-tag-new">NEW: {{ cat }}</a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="admin-stats">
        <h2>Database Status</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_documents }}</div>
                <div class="stat-label">Local Documents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_emails }}</div>
                <div class="stat-label">Emails</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_entities }}</div>
                <div class="stat-label">Entities</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_threads }}</div>
                <div class="stat-label">Threads</div>
            </div>
        </div>
    </div>

    <div class="admin-section admin-section-highlight">
        <h2>Data Sources</h2>
        <p>Import structured data and bulk documents for AI analysis.</p>

        <div class="data-source-grid">
            <div class="data-source-card">
                <h4>Hugging Face: House Oversight 20K+</h4>
                <p>25,800 OCR'd documents from the Nov 2025 House Oversight Committee release.
                   Source: <a href="https://huggingface.co/datasets/tensonaut/EPSTEIN_FILES_20K" target="_blank" rel="noopener">tensonaut/EPSTEIN_FILES_20K</a></p>
                <button class="btn btn-primary" onclick="importData('huggingface')" id="btn-hf">Import HF Dataset</button>
                <span class="import-status" id="status-hf"></span>
            </div>

            <div class="data-source-card">
                <h4>Archive CSVs: Entities + Relationships + Flights</h4>
                <p>96 entities, 1,007 relationships, 55 flight records from
                   <a href="https://www.epsteininvestigation.org/download" target="_blank" rel="noopener">epsteininvestigation.org</a></p>
                <button class="btn btn-primary" onclick="importData('archive_csvs')" id="btn-csv">Import Archive CSVs</button>
                <span class="import-status" id="status-csv"></span>
            </div>

            <div class="data-source-card">
                <h4>DocETL Reference</h4>
                <p>See <a href="https://www.docetl.org/showcase/epstein-email-explorer" target="_blank" rel="noopener">DocETL Epstein Email Explorer</a>
                   and <a href="https://dicklesworthstone.github.io/ees/" target="_blank" rel="noopener">EES (Epstein Emails Search)</a>
                   for related projects analysing the same corpus.</p>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <h2>Manual Ingestion (CLI)</h2>
        <code class="admin-code">python ingest.py doj</code>
        <code class="admin-code">python ingest.py local data/pdfs</code>
        <code class="admin-code">python ingest.py threads</code>
    </div>

    {% if jobs %}
    <div class="admin-section">
        <h2>Ingestion Jobs</h2>
        <table class="admin-table">
            <thead>
                <tr><th>ID</th><th>Source</th><th>Status</th><th>Found</th><th>Processed</th><th>Started</th></tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr>
                    <td>{{ job.id }}</td>
                    <td>{{ job.source }}</td>
                    <td><span class="badge badge-{{ 'success' if job.status == 'completed' else 'warning' }}">{{ job.status }}</span></td>
                    <td>{{ job.documents_found or 0 }}</td>
                    <td>{{ job.documents_processed or 0 }}</td>
                    <td>{{ job.started_at or '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
function workerAction(action) {
    fetch("/api/worker/" + action, { method: "POST" })
        .then(function(r) { return r.json(); })
        .then(function() { setTimeout(function() { location.reload(); }, 1000); })
        .catch(function(e) { alert("Error: " + e); });
}
function importData(source) {
    var key = (source === "archive_csvs") ? "csv" : "hf";
    var btn = document.getElementById("btn-" + key);
    var status = document.getElementById("status-" + key);
    btn.disabled = true;
    btn.textContent = "Importing\u2026";
    status.textContent = "";
    status.style.color = "";
    fetch("/api/ingest", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({source: source})
    })
    .then(function(r) { return r.json().then(function(d) { return {ok: r.ok, data: d}; }); })
    .then(function(result) {
        if (!result.ok || result.data.status === "error") {
            btn.disabled = false;
            btn.textContent = "Retry";
            status.style.color = "#ff4444";
            status.textContent = "Error: " + (result.data.error || "Import failed");
            return;
        }
        var data = result.data;
        btn.textContent = "Done";
        if (data.documents_imported !== undefined) {
            status.textContent = data.documents_imported + " documents imported";
        } else if (data.results) {
            var parts = [];
            for (var k in data.results) parts.push(data.results[k] + " " + k);
            status.textContent = parts.join(", ");
        }
        setTimeout(function() { location.reload(); }, 2000);
    })
    .catch(function(e) {
        btn.disabled = false;
        btn.textContent = "Retry";
        status.style.color = "#ff4444";
        status.textContent = "Error: " + e.message;
    });
}
function refreshStatus() {
    fetch("/api/worker/status")
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById("ws-task").textContent = data.current_task;
            document.getElementById("ws-docs").textContent = data.documents_analysed;
            document.getElementById("ws-cats").textContent = data.categories_discovered;
        });
}
{% if worker.running %}
(function poll() {
    setTimeout(function() {
        refreshStatus();
        poll();
    }, 5000);
})();
{% endif %}
</script>
{% endblock %}
