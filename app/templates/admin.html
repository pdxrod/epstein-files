{% extends "base.html" %}
{% block title %}Admin — Epstein Files{% endblock %}

{% block content %}
<section class="admin-page">
    <h1>Admin / Data Ingestion</h1>

    <div class="admin-stats">
        <h2>Database Status</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_documents }}</div>
                <div class="stat-label">Local Documents</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_emails }}</div>
                <div class="stat-label">Emails</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_entities }}</div>
                <div class="stat-label">Entities</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stats.total_threads }}</div>
                <div class="stat-label">Threads</div>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <h2>Live Search (no ingestion needed)</h2>
        <p>The app automatically queries the <a href="https://www.epsteininvestigation.org" target="_blank" rel="noopener">Epstein Document Archive</a>
           when the local database has no results. This gives you access to <strong>207,000+ documents</strong> immediately.</p>
        <p>Ingesting data locally allows the NLP pipeline to run (entity extraction, threading, deduplication, relevance scoring),
           but searching works out of the box via the live API fallback.</p>
    </div>

    <div class="admin-section">
        <h2>Ingest from DOJ</h2>
        <p>Download and process documents from <a href="https://www.justice.gov/epstein" target="_blank">justice.gov/epstein</a>.
           This takes a long time (thousands of PDFs). Run from the command line for large jobs:</p>
        <code class="admin-code">python ingest.py doj</code>
        <p>Or with Docker:</p>
        <code class="admin-code">docker-compose exec web python ingest.py doj</code>
    </div>

    <div class="admin-section">
        <h2>Ingest Local PDFs</h2>
        <p>If you have downloaded PDF files, place them in <code>data/pdfs/</code> and run:</p>
        <code class="admin-code">python ingest.py local data/pdfs</code>
    </div>

    <div class="admin-section">
        <h2>Build Email Threads</h2>
        <p>After ingesting emails, group them into chronological threads:</p>
        <code class="admin-code">python ingest.py threads</code>
    </div>

    {% if jobs %}
    <div class="admin-section">
        <h2>Recent Ingestion Jobs</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Source</th>
                    <th>Status</th>
                    <th>Found</th>
                    <th>Processed</th>
                    <th>Started</th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr>
                    <td>{{ job.id }}</td>
                    <td>{{ job.source }}</td>
                    <td><span class="badge badge-{{ 'success' if job.status == 'completed' else 'warning' if job.status == 'running' else 'type' }}">{{ job.status }}</span></td>
                    <td>{{ job.documents_found or 0 }}</td>
                    <td>{{ job.documents_processed or 0 }}</td>
                    <td>{{ job.started_at or '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</section>
{% endblock %}
