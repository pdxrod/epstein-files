{% extends "base.html" %}
{% block title %}Epstein Files Search — Home{% endblock %}

{% block content %}
<section class="hero">
    <h1>Epstein Files Search</h1>
    <p class="hero-subtitle">AI-powered search across 207,000+ documents, emails, and records</p>

    <form action="{{ url_for('main.search_page') }}" method="GET" class="hero-search">
        <input type="text" name="q" placeholder="Search names, subjects, dates, keywords… (handles misspellings)"
               class="search-input-large" autofocus autocomplete="off">
        <button type="submit" class="btn btn-primary btn-large">Search</button>
    </form>
    <p class="hero-note">Try "Lesly Goff" to find "Lesley Groff" — fuzzy matching handles Epstein's notorious misspellings</p>
</section>

{% if worker.running %}
<div class="worker-banner worker-banner-active" id="worker-banner">
    <div class="worker-banner-dot"></div>
    <span>AI is analysing documents: <strong id="worker-task">{{ worker.current_task }}</strong></span>
    <span class="worker-banner-stats">
        {{ worker.documents_analysed }} analysed · {{ worker.categories_discovered }} categories discovered
    </span>
</div>
{% elif not has_data %}
<div class="first-run-banner">
    <h3>Live search is active</h3>
    <p>Searching queries the <a href="https://www.epsteininvestigation.org" target="_blank" rel="noopener">Epstein Document Archive</a> API
       (207K+ documents from DOJ, FBI, and House Oversight). Results link to original PDFs and
       <a href="https://jmail.world" target="_blank" rel="noopener">jmail.world</a>.</p>
    <p>To enable AI analysis (category discovery, relevance scoring, entity extraction), go to
       <a href="{{ url_for('main.admin_page') }}">Admin</a> and start the AI worker.
       Requires <a href="https://ollama.ai" target="_blank" rel="noopener">Ollama</a> running locally.</p>
</div>
{% endif %}

<section class="search-modes">
    <h2>Browse by</h2>
    <div class="mode-grid">
        <a href="{{ url_for('main.search_page', type='name') }}" class="mode-card">
            <div class="mode-icon">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>
            <h3>Search by Name</h3>
            <p>Find documents mentioning any person — handles misspellings and name variations</p>
        </a>

        <a href="{{ url_for('main.timeline_page') }}" class="mode-card">
            <div class="mode-icon">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
            </div>
            <h3>Search by Date</h3>
            <p>Explore the chronological timeline of documents, emails, and events</p>
        </a>

        <a href="#categories" class="mode-card">
            <div class="mode-icon">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <h3>Search by Category</h3>
            <p>Browse documents grouped by topic — categories grow as AI discovers new themes</p>
        </a>

        <a href="{{ url_for('main.random_page') }}" class="mode-card mode-card-highlight">
            <div class="mode-icon">
                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
            </div>
            <h3>Random Interesting Documents</h3>
            <p>Discover high-relevance documents you might otherwise never find</p>
        </a>
    </div>
</section>

<section class="categories-section" id="categories">
    <h2>Categories</h2>
    {% if ai_categories %}
    <h3 class="category-section-label">AI-Discovered</h3>
    <p class="section-note">New categories the AI has identified across documents. This list grows as more documents are analysed.</p>
    <div class="category-grid">
        {% for cat in ai_categories %}
        <a href="{{ url_for('main.category_view', slug=cat.slug) }}" class="category-card category-card-ai">
            <h4>{{ cat.name }}</h4>
            <span class="badge badge-ai">AI</span>
            <span class="badge">{{ cat.document_count | default(0) }} docs</span>
            {% if cat.description %}
            <p>{{ cat.description }}</p>
            {% endif %}
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <h3 class="category-section-label">Core Categories</h3>
    <div class="category-grid">
        {% for cat in categories %}
        <a href="{{ url_for('main.category_view', slug=cat.slug) }}" class="category-card">
            <h4>{{ cat.name }}</h4>
            <span class="badge">{{ cat.document_count | default(0) }} docs</span>
            {% if cat.description %}
            <p>{{ cat.description }}</p>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</section>

<section class="stats-section">
    <h2>Archive Statistics</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_documents | default(0) | int }}</div>
            <div class="stat-label">Local Documents</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_emails | default(0) | int }}</div>
            <div class="stat-label">Emails</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_entities | default(0) | int }}</div>
            <div class="stat-label">Named Entities</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_threads | default(0) | int }}</div>
            <div class="stat-label">Email Threads</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.high_relevance | default(0) | int }}</div>
            <div class="stat-label">High-Relevance</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="cat-count">{{ (categories | length) + (ai_categories | length) }}</div>
            <div class="stat-label">Categories</div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{% if worker.running %}
<script>
(function() {
    function pollWorker() {
        fetch("/api/worker/status")
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var el = document.getElementById("worker-task");
                if (el) el.textContent = data.current_task || "idle";
                var banner = document.getElementById("worker-banner");
                if (banner) {
                    var stats = banner.querySelector(".worker-banner-stats");
                    if (stats) stats.textContent = data.documents_analysed + " analysed \u00b7 " + data.categories_discovered + " categories discovered";
                }
                if (data.running) setTimeout(pollWorker, 5000);
                else if (banner) banner.classList.remove("worker-banner-active");
            })
            .catch(function() { setTimeout(pollWorker, 15000); });
    }
    setTimeout(pollWorker, 5000);
})();
</script>
{% endif %}
{% endblock %}
